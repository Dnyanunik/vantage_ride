<nav class="cockpit-nav" [class.scrolled]="isScrolled">

  <div class="brand-zone">
    <div class="logo-text">
      VANTAGE <span class="highlight">RIDE</span>
    </div>
    <div class="status-indicator">
      <span class="dot"></span>
      {{ themeService.themeSignal() === 'dark' ? 'NIGHT DRIVE' : 'DAY TRIP' }}
    </div>
  </div>

  <div class="desktop-menu">
    <a routerLink="/" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">Home</a>
    <a routerLink="/services" class="nav-link" routerLinkActive="active">Services</a>
    <a routerLink="/about" class="nav-link" routerLinkActive="active">About US</a>

    <a *ngIf="!currentUser" routerLink="/login" class="nav-link">Login</a>

    <div *ngIf="currentUser" class="user-session-wrapper">

      <app-notification-driver></app-notification-driver>
      <app-notification-user></app-notification-user>

      <button class="session-trigger" [matMenuTriggerFor]="userMenu">
        <div class="avatar-ring">
          <img [src]="userAvatar" alt="Pilot Avatar" class="navbar-avatar">
        </div>
        <span class="user-name">{{ userDisplayName }}</span>
        <mat-icon>expand_more</mat-icon>
      </button>

      <mat-menu #userMenu="matMenu" class="cockpit-dropdown">
        <div class="menu-header">
        <span class="role-tag">{{ currentUser ? currentUser.user_metadata['role'] || 'PASSENGER' : 'PASSENGER' }}</span>
          <p class="email-sub">{{ currentUser.email }}</p>
        </div>
        <button mat-menu-item routerLink="/profile"><mat-icon>account_circle</mat-icon><span>My Profile</span></button>
        <button mat-menu-item *ngIf="currentUser?.user_metadata?.['role'] === 'driver'" routerLink="/manage-fleet"><mat-icon>directions_car</mat-icon><span>Manage Fleet</span></button>
        <button mat-menu-item *ngIf="currentUser?.user_metadata?.['role'] === 'driver'" routerLink="/pilot-routes"><mat-icon>add_circle</mat-icon><span>Create Package</span></button>
        <button mat-menu-item routerLink="/my-rides"><mat-icon>history</mat-icon><span>Ride History</span></button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="handleLogout()" class="logout-item"><mat-icon>power_settings_new</mat-icon><span>Terminate Session</span></button>
      </mat-menu>
    </div>
  </div>

  <div class="action-zone">
    <button class="theme-toggle" (click)="themeService.toggleTheme()" title="Switch Theme">
      <svg *ngIf="themeService.themeSignal() === 'light'" class="theme-icon moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
      <svg *ngIf="themeService.themeSignal() === 'dark'" class="theme-icon sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </button>

    <button class="book-btn-desktop" (click)="openBookingDialog()">
      <span class="icon">üèéÔ∏è</span> Book Ride
    </button>

    <div class="nav-notifications">
      <app-notification-driver></app-notification-driver>
      <app-notification-user></app-notification-user>
    </div>

    <button class="mobile-toggle" (click)="toggleMenu()" [class.open]="isMenuOpen">
      <span class="bar top"></span>
      <span class="bar mid"></span>
      <span class="bar bot"></span>
    </button>
  </div>
</nav>

<div class="mobile-overlay" [class.active]="isMenuOpen">
  <div class="cockpit-glare"></div>

  <div class="hud-header">
    <div class="hud-top">
      <span class="hud-unit">VR_V1.0</span>
      <button class="hud-close" (click)="toggleMenu()">
        <mat-icon>power_settings_new</mat-icon>
      </button>
    </div>
    <div class="hud-title">
      <h1>VANTAGE<span>RIDE</span></h1>
      <p>PREMIUM TOURS & TRAVELS</p>
    </div>
  </div>

  <div class="mobile-links">
    <div *ngIf="currentUser" class="mobile-profile-card" style="--i:0;">
       <img [src]="userAvatar" alt="Pilot Avatar" class="mobile-avatar">
       <div class="mobile-user-info">
         <span class="mobile-user-name">{{ userDisplayName }}</span>
         <span class="mobile-user-email">{{ currentUser.email }}</span>
       </div>
    </div>

    <a routerLink="/" (click)="toggleMenu()" style="--i:1;">
      <div class="icon-box"><mat-icon>home</mat-icon></div><span>Home</span>
    </a>
    <a routerLink="/services" (click)="toggleMenu()" style="--i:2;">
      <div class="icon-box"><mat-icon>verified</mat-icon></div><span>Services</span>
    </a>
    <a routerLink="/about" (click)="toggleMenu()" style="--i:3;">
      <div class="icon-box"><mat-icon>hub</mat-icon></div><span>About US</span>
    </a>

    <ng-container *ngIf="currentUser">
      <a routerLink="/profile" (click)="toggleMenu()" style="--i:3.5;">
        <div class="icon-box"><mat-icon>account_circle</mat-icon></div><span>My Profile</span>
      </a>
      <a routerLink="/my-rides" (click)="toggleMenu()" style="--i:3.6;">
        <div class="icon-box"><mat-icon>history</mat-icon></div><span>Ride History</span>
      </a>
      <a *ngIf="currentUser.user_metadata?.['role'] === 'driver'" routerLink="/pilot-routes" (click)="toggleMenu()" style="--i:3.6;">
        <div class="icon-box"><mat-icon>history</mat-icon></div><span>Create Ride</span>
      </a>
      <a *ngIf="currentUser.user_metadata?.['role'] === 'driver'" routerLink="/manage-fleet" (click)="toggleMenu()" style="--i:3.7;">
        <div class="icon-box"><mat-icon>directions_car</mat-icon></div><span>Manage Fleet</span>
      </a>
    </ng-container>

    <a *ngIf="!currentUser" routerLink="/login" (click)="toggleMenu()" style="--i:4;">
      <div class="icon-box"><mat-icon>login</mat-icon></div><span>Login</span>
    </a>
    <a *ngIf="currentUser" (click)="handleLogout(); toggleMenu()" style="--i:4;" class="logout-link">
      <div class="icon-box"><mat-icon>logout</mat-icon></div><span>Terminate Session</span>
    </a>
  </div>

  <div class="mobile-controls">
    <div class="controls-row" style="--i:5;">
      <button class="theme-dashboard-toggle" (click)="themeService.toggleTheme()">
         <span class="label">DRIVE MODE</span>
         <div class="status">
           <mat-icon>{{ themeService.themeSignal() === 'dark' ? 'dark_mode' : 'light_mode' }}</mat-icon>
           {{ themeService.themeSignal() === 'dark' ? 'STEALTH' : 'DAYLIGHT' }}
         </div>
      </button>

      <div class="ignition-zone" style="--i:6;">
        <button class="mobile-book-btn" (click)="openBookingDialog(); toggleMenu()">
          <div class="btn-inner">
            <mat-icon>auto_awesome</mat-icon>
            <span>BOOK LUXURY RIDE</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>
